<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formal Complaint Letter - City Sense</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #e5e7eb;
            --text-muted: #9ca3af;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-dark: #0a0f1e;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--surface);
            color: var(--text);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .back-button:hover {
            background: var(--surface-dark);
            transform: translateX(-5px);
        }

        .loading {
            text-align: center;
            padding: 4rem 0;
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .complaint-container {
            background: white;
            color: #000;
            padding: 4rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
        }

        .complaint-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px double #333;
        }

        .complaint-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .complaint-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .meta-value {
            color: #1a1a1a;
            font-weight: 500;
        }

        .complaint-content {
            line-height: 2;
            color: #1a1a1a;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 1rem;
            text-align: justify;
        }

        .complaint-content p {
            margin-bottom: 1.5rem;
        }

        .signature-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #ddd;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-outline:hover {
            background: var(--surface);
            transform: translateY(-2px);
        }

        .error-message {
            text-align: center;
            padding: 3rem;
            background: var(--surface);
            border-radius: 12px;
            border-left: 4px solid var(--danger);
        }

        .error-message i {
            font-size: 3rem;
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .error-message h3 {
            color: var(--danger);
            margin-bottom: 0.5rem;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .back-button,
            .action-buttons,
            .header {
                display: none !important;
            }

            .complaint-container {
                box-shadow: none;
                padding: 2rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .complaint-container {
                padding: 2rem 1.5rem;
            }

            .complaint-header h2 {
                font-size: 1.4rem;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.info {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="#" onclick="goBackToDashboard(event)" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>

        <div class="header">
            <h1><i class="fas fa-file-contract"></i> Formal Complaint Letter</h1>
            <p>AI-Generated Official Document</p>
        </div>

        <div id="loadingContainer" class="loading">
            <i class="fas fa-spinner"></i>
            <p style="margin-top: 1rem; color: var(--text-muted);">Loading complaint letter...</p>
        </div>

        <div id="contentContainer" style="display: none;">
            <div class="complaint-container" id="complaintDocument">
                <div class="complaint-header">
                    <h2>Official Complaint Letter</h2>
                    <p style="color: #666; margin-top: 0.5rem;">City Sense Community Reporting Platform</p>
                </div>

                <div class="complaint-meta" id="metaInfo">
                    <!-- Meta information will be inserted here -->
                </div>

                <div class="complaint-content" id="complaintContent">
                    <!-- Complaint letter content will be inserted here -->
                </div>

                <!-- Photo Evidence Section -->
                <div id="photoEvidenceSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #ddd;">
                    <h3 style="color: #1a1a1a; margin-bottom: 1rem; font-family: 'Playfair Display', serif;">
                        <i class="fas fa-camera"></i> Photographic Evidence
                    </h3>
                    <div id="photoEvidenceContainer" style="text-align: center;">
                        <!-- Photo will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="downloadAsPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Download as PDF
                </button>
                <button class="btn btn-success" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i>
                    Copy to Clipboard
                </button>
                <button class="btn btn-outline" onclick="printComplaint()">
                    <i class="fas fa-print"></i>
                    Print Letter
                </button>
            </div>
        </div>

        <div id="errorContainer" style="display: none;">
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Unable to Load Complaint</h3>
                <p id="errorMessage">An error occurred while loading the complaint letter.</p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let reportData = null;

        // Get report ID from URL
        function getReportIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Load complaint letter
        async function loadComplaintLetter() {
            const reportId = getReportIdFromURL();
            
            if (!reportId) {
                showError('No report ID provided');
                return;
            }

            try {
                const snap = await db.collection("reports").doc(reportId).get();
                
                if (!snap.exists) {
                    showError('Report not found');
                    return;
                }

                reportData = { id: reportId, ...snap.data() };

                if (!reportData.aiComplaintLetter) {
                    showError('AI complaint letter has not been generated yet for this report');
                    return;
                }

                displayComplaintLetter(reportData);

            } catch (error) {
                console.error('Error loading complaint:', error);
                showError('Failed to load complaint letter: ' + error.message);
            }
        }

        // Display complaint letter
        function displayComplaintLetter(data) {
            // Format date - handle both ISO strings and Firebase Timestamp objects
            let date = 'N/A';
            if (data.createdAt) {
                try {
                    // If it's an ISO string, use it directly
                    if (typeof data.createdAt === 'string') {
                        date = new Date(data.createdAt).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } 
                    // If it's a Firebase Timestamp object with toDate method
                    else if (data.createdAt.toDate && typeof data.createdAt.toDate === 'function') {
                        date = data.createdAt.toDate().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    // If it's already a Date object
                    else if (data.createdAt instanceof Date) {
                        date = data.createdAt.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    // Last resort: try to convert to Date
                    else {
                        date = new Date(data.createdAt).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                } catch (e) {
                    console.error('Date formatting error:', e);
                    date = 'N/A';
                }
            }

            // Populate meta information
            const metaInfo = document.getElementById('metaInfo');
            metaInfo.innerHTML = `
                <div class="meta-item">
                    <div class="meta-label">Report ID</div>
                    <div class="meta-value">#${data.id.slice(-8).toUpperCase()}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Reporter Name</div>
                    <div class="meta-value">${data.reporterName || 'Anonymous'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Reporter Email</div>
                    <div class="meta-value">${data.reporterEmail || 'Not provided'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Incident Type</div>
                    <div class="meta-value">${data.incidentType || 'N/A'}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Date Filed</div>
                    <div class="meta-value">${date}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Location</div>
                    <div class="meta-value">${data.latitude ? `${Number(data.latitude).toFixed(4)}, ${Number(data.longitude).toFixed(4)}` : 'N/A'}</div>
                </div>
            `;

            // Display complaint content
            document.getElementById('complaintContent').textContent = data.aiComplaintLetter;

            // Display photo evidence if available
            if (data.photoUrl) {
                const photoSection = document.getElementById('photoEvidenceSection');
                const photoContainer = document.getElementById('photoEvidenceContainer');
                
                photoContainer.innerHTML = `
                    <img src="${data.photoUrl}" 
                         alt="Evidence Photo" 
                         style="max-width: 100%; max-height: 500px; border: 3px solid #2563eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                         onclick="window.open('${data.photoUrl}', '_blank')">
                    <p style="margin-top: 1rem; color: #666; font-style: italic; cursor: pointer;" onclick="window.open('${data.photoUrl}', '_blank')">
                        <i class="fas fa-search-plus"></i> Click image to view full size
                    </p>
                `;
                
                photoSection.style.display = 'block';
            }

            // Show content, hide loading
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';
        }

        // Show error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
        }

        // Copy to clipboard
        function copyToClipboard() {
            const content = reportData.aiComplaintLetter;
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Complaint letter copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy: ' + err.message, 'error');
            });
        }

        // Print complaint
        function printComplaint() {
            window.print();
        }

        // Download as PDF
        async function downloadAsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Set up document properties
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('OFFICIAL COMPLAINT LETTER', pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 10;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('City Sense Community Reporting Platform', pageWidth / 2, yPosition, { align: 'center' });
                
                yPosition += 10;
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;

                // Meta information
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                const addMetaField = (label, value) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label + ':', margin, yPosition);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, margin + 40, yPosition);
                    yPosition += 6;
                };

                addMetaField('Report ID', '#' + reportData.id.slice(-8).toUpperCase());
                addMetaField('Reporter', reportData.reporterName || 'Anonymous');
                addMetaField('Email', reportData.reporterEmail || 'Not provided');
                addMetaField('Incident Type', reportData.incidentType || 'N/A');
                
                // Handle date formatting
                let dateStr = 'N/A';
                try {
                    if (reportData.createdAt) {
                        if (typeof reportData.createdAt === 'string') {
                            dateStr = new Date(reportData.createdAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        } else if (reportData.createdAt.toDate && typeof reportData.createdAt.toDate === 'function') {
                            dateStr = reportData.createdAt.toDate().toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        } else {
                            dateStr = new Date(reportData.createdAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                    }
                } catch (e) {
                    console.error('PDF date formatting error:', e);
                }
                
                addMetaField('Date Filed', dateStr);
                addMetaField('Location', reportData.latitude ? 
                    `${Number(reportData.latitude).toFixed(4)}, ${Number(reportData.longitude).toFixed(4)}` : 'N/A');

                yPosition += 5;
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;

                // Complaint content
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const complaintText = reportData.aiComplaintLetter;
                const lines = doc.splitTextToSize(complaintText, contentWidth);
                
                for (let i = 0; i < lines.length; i++) {
                    if (yPosition > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    doc.text(lines[i], margin, yPosition);
                    yPosition += 6;
                }

                // Add photo evidence note if photo exists
                if (reportData.photoUrl) {
                    yPosition += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text('Evidence:', margin, yPosition);
                    yPosition += 6;
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(9);
                    doc.text('Photographic evidence is available with this report.', margin, yPosition);
                    yPosition += 5;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Photo URL: ' + reportData.photoUrl, margin, yPosition);
                    doc.setTextColor(0, 0, 0);
                }

                // Footer
                const filename = `complaint_letter_${reportData.id.slice(-8)}_${Date.now()}.pdf`;
                doc.save(filename);
                
                showNotification('PDF downloaded successfully!', 'success');

            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Failed to generate PDF: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadComplaintLetter();
        });

        // Handle back to dashboard navigation
        function goBackToDashboard(event) {
            event.preventDefault();
            
            // Check if user is an authority user
            const isAuthority = sessionStorage.getItem('isAuthorityAuthenticated') === 'true';
            
            if (isAuthority) {
                // Authority user - go to authority dashboard
                sessionStorage.setItem('navigateTo', 'authority');
            } else {
                // Regular user - go to user dashboard
                sessionStorage.setItem('navigateTo', 'user-dashboard');
            }
            
            // Navigate to index
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>